# Known框架完整项目文档

## 目录

- [1. 项目概述](#1-项目概述)
- [2. 主要功能说明](#2-主要功能说明)
- [3. 技术架构](#3-技术架构)
- [4. 核心模块接口文档](#4-核心模块接口文档)
- [5. 使用示例](#5-使用示例)
- [6. 部署指南](#6-部署指南)

---

## 1. 项目概述

### 1.1 项目简介

**Known** 是基于 **Blazor** 的轻量级、跨平台、极易扩展的插件开发框架。采用 C# 全栈开发模式，前端与后端统一使用 C# 语言，大幅降低学习成本和开发复杂度。

### 1.2 核心特性

| 特性 | 说明 |
|------|------|
| **插件开发** | 基于 Blazor 实现的模块化插件架构，支持热插拔 |
| **通用权限** | 内置基于角色的权限控制系统，URL 级别权限检查 |
| **低代码开发** | 支持在线配置表单和页面，快速构建业务功能 |
| **国际化** | 完备的多语言解决方案，默认支持简体中文 |
| **现代 UI** | 基于 Ant Design 设计风格的现代化界面 |
| **C# 全栈** | 前后端统一使用 C# 语言，无需学习 JavaScript |
| **多平台支持** | 支持 Web、桌面应用（WinForm、MAUI、Photino）、WASM |

### 1.3 支持的技术栈

- **.NET 版本**: .NET 8.0, .NET 9.0, .NET 10.0
- **前端框架**: Blazor Server, Blazor WebAssembly
- **UI 框架**: AntDesign Blazor
- **数据库**: MySQL, SQL Server, PostgreSQL, SQLite, Oracle, DM (达梦), Access
- **认证方式**: Cookie, Session, Identity
- **通信协议**: HTTP, SignalR

### 1.4 项目结构

```
Known/
├── Known/                    # 框架核心类库
│   ├── Components/           # Blazor 组件库
│   ├── Services/             # 服务层（业务逻辑）
│   ├── Entities/             # 实体模型（系统表）
│   ├── Data/                 # 数据访问层
│   ├── Pages/                # 系统页面
│   ├── Blazor/               # Blazor 基类和构建器
│   ├── Weixins/              # 微信集成模块
│   ├── WorkFlows/            # 工作流模块
│   └── Resources/            # 多语言资源
├── Plugins/                  # 插件目录
│   ├── Known.Core/           # 核心插件（服务端）
│   ├── Known.Cells/          # Excel 导入导出插件
│   └── Known.Sample/         # 示例插件
├── Known.Server/             # Server 模式示例
├── Known.Wasm/               # WebAssembly 前端示例
├── Known.WasmHost/           # WebAssembly 后端示例
├── Known.WinForm/            # WinForm 桌面应用示例
├── Known.Maui/               # MAUI 跨平台应用示例
├── Known.Photino/            # Photino 桌面应用示例
└── Document/                 # 文档目录
```

### 1.5 开源信息

- **官网**: https://known.org.cn
- **Gitee**: https://gitee.com/known/Known
- **GitHub**: https://github.com/known/Known
- **许可证**: Apache-2.0
- **QQ群**: 865982686

---

## 2. 主要功能说明

### 2.1 系统管理模块

#### 2.1.1 用户管理

- 功能：用户信息的增删改查、密码重置、部门调整、用户启用/禁用
- 特性：支持批量导入导出、多租户隔离

#### 2.1.2 角色管理

- 功能：角色创建与配置、权限分配
- 特性：支持角色继承、细粒度权限控制

#### 2.1.3 组织机构管理

- 功能：树形组织结构管理、部门层级维护
- 特性：支持拖拽调整、批量操作

#### 2.1.4 系统菜单管理

- 功能：菜单配置、按钮权限管理
- 特性：动态加载、权限过滤

#### 2.1.5 数据字典管理

- 功能：字典类别与项目管理
- 特性：支持多语言、缓存机制

#### 2.1.6 系统日志管理

- 功能：操作日志、登录日志、系统错误日志
- 特性：支持日志查询、导出、定期清理

#### 2.1.7 系统配置管理

- 功能：系统参数配置、界面设置
- 特性：支持热更新、多实例配置

#### 2.1.8 定时任务管理

- 功能：Cron 表达式任务配置、任务执行监控
- 特性：支持立即执行、暂停/恢复

### 2.2 开发中心模块

#### 2.2.1 在线表单配置

- 功能：动态表单设计、字段属性配置
- 特性：支持多种字段类型、数据绑定、验证规则

#### 2.2.2 在线页面配置

- 功能：页面表格配置、查询条件设置
- 特性：支持列排序、汇总、导出

#### 2.2.3 代码生成

- 功能：基于实体自动生成代码
- 生成内容：实体类、DTO、服务接口、服务实现、页面组件、表单组件

#### 2.2.4 WebApi 测试

- 功能：在线 API 调试、参数配置
- 特性：支持 GET/POST、请求历史记录

### 2.3 基础功能模块

#### 2.3.1 文件管理

- 功能：文件上传下载、预览
- 特性：支持多格式、文件压缩

#### 2.3.2 消息通知

- 功能：实时消息推送、系统公告
- 技术：SignalR 实现双向通信

#### 2.3.3 国际化

- 功能：多语言切换、语言包管理
- 支持：中文、英文等

#### 2.3.4 主题切换

- 功能：亮色/暗色主题、字体大小调整
- 特性：自定义主题配色

### 2.4 扩展功能模块

#### 2.4.1 微信集成

- 功能：微信公众号、小程序接入
- 特性：消息推送、用户授权、支付集成

#### 2.4.2 工作流

- 功能：流程定义、流程实例管理、任务处理
- 特性：可视化流程设计、审批流

#### 2.4.3 Excel 集成

- 功能：Excel 模板导入导出、数据透视表
- 依赖：Aspose.Cells

---

## 3. 技术架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                           表现层 (Presentation)                    │
├──────────────┬──────────────┬──────────────┬─────────────────────┤
│   Web应用    │  WinForm应用 │   MAUI应用   │  Photino应用        │
│ (Blazor S/W) │   (.NET)     │   (.NET)     │     (.NET)          │
└──────┬───────┴───────┬──────┴───────┬──────┴───────┬───────────┘
       │              │              │              │
       └──────────────┼──────────────┼──────────────┘
                      │              │
┌─────────────────────┴──────────────┴─────────────────────────────┐
│                       UI组件层 (Components)                        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  AntDesign Blazor组件 + Known自定义组件                      │ │
│  │  (KButton, KTable, KForm, KUpload, KChart, ...)           │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────┴──────────────────────────────────┐
│                       服务层 (Services)                          │
│  ┌─────────────────┬─────────────────┬───────────────────────┐ │
│  │  系统服务       │   业务服务       │   插件服务             │ │
│  │  (UserService,  │   (自定义服务)   │   (PluginService)     │ │
│  │   RoleService,  │                   │                       │ │
│  │   LogService)   │                   │                       │ │
│  └─────────────────┴─────────────────┴───────────────────────┘ │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────┴──────────────────────────────────┐
│                     数据访问层 (Data Access)                       │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Database 类 (支持多种数据库)                                 │ │
│  │  MySQL | SQL Server | PostgreSQL | SQLite | Oracle | DM    │ │
│  └─────────────────────────────────────────────────────────────┘ │
└──────────────────────────────┬──────────────────────────────────┘
                               │
┌──────────────────────────────┴──────────────────────────────────┐
│                       基础设施层 (Infrastructure)                  │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  缓存 | 日志 | 权限认证 | 事件总线 | 任务调度               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 核心类图

```
┌─────────────────┐
│    Config       │ ────── 全局配置
│  (静态类)       │
└────────┬────────┘
         │
         │ 包含
         ├──────────────────┐
         │                  │
    ┌────▼────┐      ┌──────▼──────┐
    │ AppInfo │      │ SystemInfo  │
    └─────────┘      └─────────────┘

┌─────────────────┐
│   EntityBase    │ ────── 实体基类
│   (泛型<T>)     │
└────────┬────────┘
         │
         │ 继承
         ├──────────────────┐
         │                  │
    ┌────▼─────┐     ┌─────▼─────┐
    │ 用户实体  │     │ 系统实体  │
    │(UserInfo) │     │ (SysUser) │
    └──────────┘     └───────────┘

┌─────────────────┐
│   ServiceBase   │ ────── 服务基类
│   (抽象类)      │
└────────┬────────┘
         │
         │ 继承
         ├──────────────────┐
         │                  │
    ┌────▼──────┐    ┌─────▼──────┐
    │ UserService│   │ LogService │
    └───────────┘    └────────────┘

┌─────────────────┐
│   Database      │ ────── 数据库访问
│   (可释放)      │
└────────┬────────┘
         │
         │ 包含
         ├──────────────────┐
         │                  │
    ┌────▼──────┐    ┌─────▼──────┐
    │ DbProvider │    │ QueryInfo  │
    └───────────┘    └────────────┘
```

### 3.3 请求处理流程

```
用户请求
    │
    ▼
┌─────────────────────┐
│   前端 Blazor 组件  │
└────────┬────────────┘
         │
         │ HTTP Request (带 Token)
         ▼
┌─────────────────────┐
│   AuthActionFilter  │ ← 权限过滤器
│   (权限检查)        │
└────────┬────────────┘
         │
         │ 通过
         ▼
┌─────────────────────┐
│   LogActionFilter   │ ← 日志过滤器
│   (操作日志记录)    │
└────────┬────────────┘
         │
         ▼
┌─────────────────────┐
│   Controller/Service │
│   (业务处理)         │
└────────┬────────────┘
         │
         ├──────────────────┐
         │                  │
         ▼                  ▼
┌──────────────┐   ┌──────────────┐
│  Database    │   │  外部服务调用 │
│  (数据访问)   │   └──────────────┘
└──────┬───────┘
       │
       ▼
┌──────────────┐
│   Response   │
│  (Result<T>) │
└──────┬───────┘
       │
       ▼
┌──────────────┐
│  返回前端     │
└──────────────┘
```

### 3.4 数据库访问架构

```
Database (主类)
    │
    ├── DatabaseOption (数据库配置)
    │   ├── ConnectionInfo[]
    │   └── DatabaseType
    │
    ├── DbProvider (数据库提供程序)
    │   ├── DbProvider.SqlServer
    │   ├── DbProvider.MySql
    │   ├── DbProvider.PostgreSQL
    │   ├── DbProvider.SQLite
    │   ├── DbProvider.Oracle
    │   ├── DbProvider.DM
    │   └── DbProvider.Access
    │
    ├── 查询方法
    │   ├── QueryListAsync<T>()
    │   ├── QueryAsync<T>()
    │   ├── QueryPageAsync<T>()
    │   └── QueryActionAsync()
    │
    ├── 执行方法
    │   ├── ExecuteAsync()
    │   ├── InsertAsync<T>()
    │   ├── UpdateAsync<T>()
    │   └── DeleteAsync<T>()
    │
    └── 事务方法
        ├── BeginTransaction()
        ├── Commit()
        └── Rollback()
```

### 3.5 插件架构

```
插件系统
    │
    ├── PluginBase (插件基类)
    │   ├── OnInitialize() - 初始化
    │   ├── OnConfigure() - 配置
    │   ├── OnStart() - 启动
    │   └── OnStop() - 停止
    │
    ├── 已有插件
    │   ├── Known.Core - 核心插件
    │   ├── Known.Cells - Excel插件
    │   └── Known.Sample - 示例插件
    │
    └── 自定义插件
        ├── 添加菜单 (AddMenu)
        ├── 添加权限 (AddPermission)
        ├── 注册服务 (Services.AddScoped)
        └── 添加路由 (路由组件)
```

---

## 4. 核心模块接口文档

### 4.1 配置模块 (Config)

#### 4.1.1 Config 类

框架全局配置类，静态访问。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `App` | AppInfo | 系统配置信息 |
| `System` | SystemInfo | 系统版本信息 |
| `IsInstalled` | bool | 系统是否已安装 |
| `IsDebug` | bool | 是否调试模式 |
| `IsDevelopment` | bool | 是否显示开发中心 |
| `DatabaseType` | DatabaseType | 数据库类型 |
| `RenderMode` | RenderType | 渲染模式 (Server/Wasm) |

**主要方法：**

```csharp
// 创建服务实例
T CreateService<T>()

// 添加模块程序集
void AddModule(Assembly assembly, bool isAdditional = true)

// 获取上传目录路径
string GetUploadDirectory(params string[] paths)

// 获取文件URL
string GetFileUrl(string filePath, bool isWeb = false)

// 获取带版本号的静态文件URL
string GetStaticFileUrl(string url)
```

#### 4.1.2 AppInfo 类

系统配置信息类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 系统ID |
| `Name` | string | 系统名称 |
| `Type` | AppType | 系统类型 (Web/WebApi/Desktop) |
| `IsPlatform` | bool | 是否多租户平台 |
| `IsMobile` | bool | 是否启用移动端 |
| `DefaultPageSize` | int | 默认分页大小 |
| `WebRoot` | string | Web根目录 |
| `UploadPath` | string | 上传目录 |
| `WebApi` | WebApiOption | WebApi配置 |
| `Database` | Action<DatabaseOption> | 数据库配置委托 |

### 4.2 实体模块 (Entity)

#### 4.2.1 EntityBase 类

数据实体基类，主键为字符串类型。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 实体ID |
| `CreateBy` | string | 创建人 |
| `CreateTime` | DateTime | 创建时间 |
| `ModifyBy` | string | 修改人 |
| `ModifyTime` | DateTime? | 修改时间 |
| `Version` | int | 版本号 |
| `Extension` | string | 扩展信息(JSON) |
| `AppId` | string | 系统ID |
| `CompNo` | string | 租户编码 |

**主要方法：**

```csharp
// 填充实体属性
void FillModel(object model)

// 实体验证
Result Validate(Context context)
```

#### 4.2.2 EntityBase<TKey> 类

泛型实体基类，支持自定义主键类型。

```csharp
public class MyEntity : EntityBase<int>
{
    public string Name { get; set; }
    public decimal Amount { get; set; }
}
```

### 4.3 服务模块 (Service)

#### 4.3.1 IService 接口

服务基础接口。

```csharp
public interface IService
{
    Context Context { get; set; }
}
```

#### 4.3.2 ServiceBase 类

业务服务抽象基类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Context` | Context | 系统上下文 |
| `CurrentUser` | UserInfo | 当前用户 |
| `Language` | Language | 语言对象 |
| `Database` | Database | 数据库访问 |

**使用示例：**

```csharp
public class MyService : ServiceBase, IMyService
{
    public MyService(Context context) : base(context) { }

    public async Task<List<MyEntity>> GetEntitiesAsync()
    {
        return await Database.QueryListAsync<MyEntity>();
    }
}
```

### 4.4 数据访问模块 (Database)

#### 4.4.1 Database 类

数据库访问主类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `ConnectionName` | string | 连接名称 |
| `DatabaseType` | DatabaseType | 数据库类型 |
| `ConnectionString` | string | 连接字符串 |
| `User` | UserInfo | 当前操作用户 |
| `EnableLog` | bool | 是否启用日志 |

**主要方法 - 查询：**

```csharp
// 查询单个实体
Task<T> QueryAsync<T>(string sql, object param = null)

// 查询实体列表
Task<List<T>> QueryListAsync<T>(string sql, object param = null)

// 分页查询
Task<PagingResult<T>> QueryPageAsync<T>(PageInfo page, QueryInfo query = null)

// 执行查询操作（用于非查询）
Task QueryActionAsync(Func<Database, Task> action)

// 执行标量查询
Task<T> QueryScalarAsync<T>(string sql, object param = null)
```

**主要方法 - 执行：**

```csharp
// 执行SQL语句
Task<int> ExecuteAsync(string sql, object param = null)

// 插入实体
Task<int> InsertAsync<T>(T entity) where T : EntityBase, new()

// 更新实体
Task<int> UpdateAsync<T>(T entity) where T : EntityBase, new()

// 删除实体
Task<int> DeleteAsync<T>(T entity) where T : EntityBase, new()
```

**主要方法 - 事务：**

```csharp
// 开始事务
Database BeginTransaction()

// 提交事务
Task CommitAsync()

// 回滚事务
Task RollbackAsync()
```

**使用示例：**

```csharp
public async Task<Result> SaveOrderAsync(Order order)
{
    using var db = Database.Create();
    db.BeginTransaction();

    try
    {
        await db.InsertAsync(order);
        
        foreach (var item in order.Items)
        {
            item.OrderId = order.Id;
            await db.InsertAsync(item);
        }

        await db.CommitAsync();
        return Result.Success("保存成功");
    }
    catch (Exception ex)
    {
        await db.RollbackAsync();
        return Result.Error($"保存失败：{ex.Message}");
    }
}
```

### 4.5 结果模块 (Result)

#### 4.5.1 Result 类

操作结果类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `IsValid` | bool | 是否成功 |
| `Message` | string | 提示消息 |
| `Data` | object | 扩展数据 |
| `IsClose` | bool | 是否关闭对话框 |

**主要方法：**

```csharp
// 返回成功结果
static Result Success(string message, object data = null)

// 返回失败结果
static Result Error(string message, object data = null)

// 添加错误信息
void AddError(string message)

// 条件验证
void Validate(bool broken, string message)

// 必填验证
void Required(Context context, string name, string value)

// 获取泛型数据
T DataAs<T>()
```

#### 4.5.2 PagingResult<T> 类

分页结果类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Page` | PageInfo | 分页信息 |
| `List` | List<T> | 数据列表 |
| `Total` | int | 总记录数 |
| `PageCount` | int | 总页数 |

### 4.6 工具模块 (Utils)

#### 4.6.1 Utils 类

系统效用工具类。

**主要方法：**

```csharp
// ID生成
static string GetNextId()                    // 获取下一个ID（根据配置）
static string GetGuid()                      // 获取GUID
static long GetSnowflakeId()                 // 获取雪花ID

// 类型转换
static T ConvertTo<T>(object value, T defaultValue = default)
static object ConvertTo(Type type, object value, object defaultValue = null)

// JSON序列化
static string ToJson(object obj)
static T FromJson<T>(string json)

// 加密解密
static string MD5Encrypt(string text)
static string AesEncrypt(string text, string key, string iv)
static string AesDecrypt(string text, string key, string iv)

// 时间处理
static string FormatDate(DateTime? dateTime, string format = null)
static int GetAge(DateTime? birthday)

// 文件处理
static string GetExtension(string fileName)
static string GetFileNameWithoutExtension(string fileName)

// HTTP请求
static async Task<string> HttpGetAsync(string url)
static async Task<T> HttpGetAsync<T>(string url)
static async Task<string> HttpPostAsync(string url, object data)
```

### 4.7 分页模块 (PageInfo)

#### 4.7.1 PageInfo 类

分页信息类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `PageNumber` | int | 当前页码 |
| `PageSize` | int | 每页大小 |
| `Total` | int | 总记录数 |
| `OrderBy` | string | 排序字段 |
| `OrderType` | OrderType | 排序方式 (Asc/Desc) |

### 4.8 组件模块 (Components)

#### 4.8.1 KButton 组件

按钮组件。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Text` | string | 按钮文本 |
| `Icon` | string | 图标 |
| `OnClick` | EventCallback | 点击事件 |
| `Type` | ButtonType | 按钮类型 |
| `Danger` | bool | 是否危险按钮 |
| `Disabled` | bool | 是否禁用 |

**使用示例：**

```razor
<KButton Text="保存" Icon="fa-save" OnClick="@OnSave" />
<KButton Text="删除" Icon="fa-trash" Danger OnClick="@OnDelete" />
```

#### 4.8.2 KTable 组件

表格组件。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `TItem` | | 泛型类型 |
| `Data` | IEnumerable<TItem> | 数据源 |
| `AutoPage` | bool | 是否自动分页 |
| `ShowPager` | bool | 是否显示分页器 |
| `OnPageChanged` | Action<PageInfo> | 分页变化事件 |
| `OnRowClick` | Action<TItem> | 行点击事件 |

**使用示例：**

```razor
<KTable TItem="MyEntity"
       Data="@entities"
       AutoPage="true"
       OnPageChanged="@OnPageChanged"
       OnRowClick="@OnRowClick">
    <PropertyColumn Property="@context.Id" Title="ID" />
    <PropertyColumn Property="@context.Name" Title="名称" />
    <ActionColumn>
        <Button Text="编辑" OnClick="@(() => OnEdit(context))" />
        <Button Text="删除" Danger OnClick="@(() => OnDelete(context))" />
    </ActionColumn>
</KTable>
```

#### 4.8.3 KUpload 组件

上传组件。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Accept` | string | 接受的文件类型 |
| `OnUpload` | Func<string[], Task<string[]>> | 上传回调 |
| `Multiple` | bool | 是否多文件 |

### 4.9 认证模块

#### 4.9.1 IAuthStateProvider 接口

认证状态提供者接口。

```csharp
public interface IAuthStateProvider
{
    Task<UserInfo> GetUserAsync();
    Task<bool> LoginAsync(LoginInfo info);
    Task LogoutAsync();
}
```

#### 4.9.2 UserInfo 类

用户信息类。

**主要属性：**

| 属性 | 类型 | 说明 |
|------|------|------|
| `Id` | string | 用户ID |
| `UserName` | string | 用户名 |
| `Name` | string | 姓名 |
| `Email` | string | 邮箱 |
| `Mobile` | string | 手机号 |
| `Avatar` | string | 头像 |
| `Roles` | List<string> | 角色列表 |
| `Permissions` | List<string> | 权限列表 |
| `Token` | string | 认证令牌 |

---

## 5. 使用示例

### 5.1 创建新项目

#### 5.1.1 Server 模式项目

**1. 创建项目：**

```bash
dotnet new blazorserver -n MyApp
cd MyApp
```

**2. 添加 NuGet 包：**

```bash
dotnet add package Known
dotnet add package Known.Core
```

**3. 配置 Program.cs：**

```csharp
using Known;
using Microsoft.AspNetCore.Identity;

var builder = WebApplication.CreateBuilder(args);

// 配置应用信息
Config.App.Id = "MyApp";
Config.App.Name = "我的应用";
Config.App.Assembly = typeof(Program).Assembly;

// 添加 Known 框架
builder.Services.AddKnownWeb(options =>
{
    options.Database = db =>
    {
        db.AddDatabase(DatabaseType.SqlServer, 
            "Server=.;Database=MyDb;Trusted_Connection=True;");
    };
});

var app = builder.Build();

// 使用 Known 中间件
app.UseKnown();

app.Run();
```

**4. 配置 appsettings.json：**

```json
{
  "ConnectionStrings": {
    "Default": "Server=.;Database=MyDb;Trusted_Connection=True;"
  },
  "Known": {
    "IsDevelopment": true,
    "IsAdminLog": true
  }
}
```

### 5.2 创建实体

```csharp
using System.ComponentModel.DataAnnotations;
using Known;

namespace MyApp.Entities
{
    /// <summary>
    /// 产品实体
    /// </summary>
    public class Product : EntityBase
    {
        [Required(ErrorMessage = "产品名称不能为空")]
        [StringLength(100, ErrorMessage = "产品名称长度不能超过100")]
        public string Name { get; set; }

        [Required(ErrorMessage = "产品编码不能为空")]
        [StringLength(50)]
        public string Code { get; set; }

        [StringLength(500)]
        public string Description { get; set; }

        [Range(0, double.MaxValue, ErrorMessage = "价格必须大于0")]
        public decimal Price { get; set; }

        [Range(0, int.MaxValue, ErrorMessage = "库存必须大于等于0")]
        public int Stock { get; set; }

        public bool IsActive { get; set; } = true;
    }
}
```

### 5.3 创建服务

**服务接口：**

```csharp
using Known;
using MyApp.Entities;

namespace MyApp.Services
{
    public interface IProductService : IService
    {
        Task<PagingResult<ProductDto>> GetProductsAsync(PageInfo page);
        Task<ProductDto> GetProductAsync(string id);
        Task<ProductDto> CreateProductAsync(ProductForm form);
        Task<ProductDto> UpdateProductAsync(string id, ProductForm form);
        Task DeleteProductAsync(string id);
        Task<bool> CheckCodeExistsAsync(string code, string excludeId = null);
    }
}
```

**服务实现：**

```csharp
using Known;
using Known.Data;
using MyApp.Entities;

namespace MyApp.Services
{
    public class ProductService : ServiceBase, IProductService
    {
        public ProductService(Context context) : base(context) { }

        public async Task<PagingResult<ProductDto>> GetProductsAsync(PageInfo page)
        {
            var query = new QueryInfo();
            
            if (!string.IsNullOrEmpty(page.Search))
            {
                query.And(nameof(Product.Name), page.Search, QueryLike.Like);
                query.Or(nameof(Product.Code), page.Search, QueryLike.Like);
            }

            query.OrderBy(nameof(Product.CreateTime), OrderType.Desc);

            var result = await Database.QueryPageAsync<ProductDto>(page, query);
            return result;
        }

        public async Task<ProductDto> GetProductAsync(string id)
        {
            var product = await Database.QueryAsync<Product>(id);
            return product.MapTo<ProductDto>();
        }

        public async Task<ProductDto> CreateProductAsync(ProductForm form)
        {
            // 检查编码是否存在
            if (await CheckCodeExistsAsync(form.Code))
            {
                throw new Exception("产品编码已存在");
            }

            var product = form.MapTo<Product>();
            await Database.InsertAsync(product);
            return product.MapTo<ProductDto>();
        }

        public async Task<ProductDto> UpdateProductAsync(string id, ProductForm form)
        {
            var product = await Database.QueryAsync<Product>(id);
            if (product == null)
            {
                throw new Exception("产品不存在");
            }

            // 检查编码是否存在
            if (await CheckCodeExistsAsync(form.Code, id))
            {
                throw new Exception("产品编码已存在");
            }

            form.MapTo(product);
            await Database.UpdateAsync(product);
            return product.MapTo<ProductDto>();
        }

        public async Task DeleteProductAsync(string id)
        {
            var product = await Database.QueryAsync<Product>(id);
            if (product == null)
            {
                throw new Exception("产品不存在");
            }

            await Database.DeleteAsync(product);
        }

        public async Task<bool> CheckCodeExistsAsync(string code, string excludeId = null)
        {
            var query = new QueryInfo();
            query.And(nameof(Product.Code), code);
            if (!string.IsNullOrEmpty(excludeId))
            {
                query.And(nameof(Product.Id), excludeId, QueryNotEqual.NotEqual);
            }

            var count = await Database.QueryScalarAsync<int>("select count(*) from Product", query.ToParam());
            return count > 0;
        }
    }
}
```

### 5.4 创建控制器

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Known;
using MyApp.Services;
using MyApp.Models;

namespace MyApp.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    [Authorize]
    public class ProductsController : ControllerBase
    {
        private readonly IProductService _service;

        public ProductsController(IProductService service)
        {
            _service = service;
        }

        /// <summary>
        /// 获取产品列表
        /// </summary>
        [HttpGet]
        public async Task<PagingResult<ProductDto>> GetProducts([FromQuery] PageInfo page)
        {
            return await _service.GetProductsAsync(page);
        }

        /// <summary>
        /// 获取产品详情
        /// </summary>
        [HttpGet("{id}")]
        public async Task<ProductDto> GetProduct(string id)
        {
            return await _service.GetProductAsync(id);
        }

        /// <summary>
        /// 创建产品
        /// </summary>
        [HttpPost]
        public async Task<ProductDto> CreateProduct([FromBody] ProductForm form)
        {
            return await _service.CreateProductAsync(form);
        }

        /// <summary>
        /// 更新产品
        /// </summary>
        [HttpPut("{id}")]
        public async Task<ProductDto> UpdateProduct(string id, [FromBody] ProductForm form)
        {
            return await _service.UpdateProductAsync(id, form);
        }

        /// <summary>
        /// 删除产品
        /// </summary>
        [HttpDelete("{id}")]
        public async Task<Result> DeleteProduct(string id)
        {
            await _service.DeleteProductAsync(id);
            return Result.Success("删除成功");
        }
    }
}
```

### 5.5 创建页面组件

**列表页面：**

```razor
@page "/products"
@inject IProductService Service
@inject NavigationManager Navigation

<PageTitle>产品管理</PageTitle>

<Card Title="产品管理">
    <Toolbar>
        <Button Text="新增" Icon="fa-plus" OnClick="@OnAdd" 
                Visible="@(User.HasPermission("Product:Create"))" />
        <Button Text="删除" Icon="fa-trash" Danger OnClick="@OnDelete" 
                Visible="@(User.HasPermission("Product:Delete"))" />
    </Toolbar>
    
    <KTable TItem="ProductDto"
           Data="@entities"
           AutoPage="true"
           ShowPager="true"
           OnPageChanged="@OnPageChanged">
        <PropertyColumn Property="@context.Id" Title="ID" Width="80" />
        <PropertyColumn Property="@context.Code" Title="编码" Width="120" />
        <PropertyColumn Property="@context.Name" Title="名称" Width="200" />
        <PropertyColumn Property="@context.Price" Title="价格" Width="100" Format="C2" />
        <PropertyColumn Property="@context.Stock" Title="库存" Width="100" />
        <PropertyColumn Property="@context.IsActive" Title="状态" Width="80">
            @context.IsActive ? "启用" : "禁用"
        </PropertyColumn>
        <PropertyColumn Property="@context.CreateTime" Title="创建时间" 
                        Format="yyyy-MM-dd HH:mm:ss" Width="150" />
        <ActionColumn>
            <Button Text="编辑" Size="Size.Small" OnClick="@(() => OnEdit(context))" 
                    Visible="@(User.HasPermission("Product:Edit"))" />
            <Button Text="删除" Size="Size.Small" Danger 
                    OnClick="@(() => OnDeleteItem(context))" 
                    Visible="@(User.HasPermission("Product:Delete"))" />
        </ActionColumn>
    </KTable>
</Card>

@if (showForm)
{
    <Modal Title="@formTitle"
           Visible="@showForm"
           OnOk="@OnSave"
           OnCancel="@OnCancel">
        <ProductFormComponent Form="@form" @ref="formComponent" />
    </Modal>
}

@code {
    private PagingResult<ProductDto> entities = new();
    private ProductForm? form;
    private ProductFormComponent? formComponent;
    private bool showForm;
    private string formTitle = "新增";
    private List<string> selectedIds = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        var page = new PageInfo { PageNumber = 1, PageSize = 20 };
        entities = await Service.GetProductsAsync(page);
    }

    private async Task OnPageChanged(PageInfo page)
    {
        entities = await Service.GetProductsAsync(page);
        StateHasChanged();
    }

    private void OnAdd()
    {
        form = new ProductForm();
        formTitle = "新增产品";
        showForm = true;
    }

    private void OnEdit(ProductDto item)
    {
        form = item.MapTo<ProductForm>();
        formTitle = "编辑产品";
        showForm = true;
    }

    private async Task OnSave()
    {
        if (formComponent?.Validate() == true)
        {
            if (string.IsNullOrEmpty(form?.Id))
            {
                await Service.CreateProductAsync(form);
            }
            else
            {
                await Service.UpdateProductAsync(form.Id, form);
            }

            showForm = false;
            await LoadData();
            UI.Success("保存成功");
        }
    }

    private void OnCancel()
    {
        showForm = false;
    }

    private async Task OnDeleteItem(ProductDto item)
    {
        if (await UI.Confirm("确定要删除这条记录吗？"))
        {
            await Service.DeleteProductAsync(item.Id);
            await LoadData();
            UI.Success("删除成功");
        }
    }

    private async Task OnDelete()
    {
        if (selectedIds.Count == 0)
        {
            UI.Warning("请选择要删除的记录");
            return;
        }

        if (await UI.Confirm($"确定要删除选中的 {selectedIds.Count} 条记录吗？"))
        {
            foreach (var id in selectedIds)
            {
                await Service.DeleteProductAsync(id);
            }
            await LoadData();
            UI.Success("删除成功");
        }
    }
}
```

**表单组件：**

```razor
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms

<EditForm Model="@Form" OnValidSubmit="@OnValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <FormRow>
        <FormItem Label="产品编码" Required="true">
            <InputText @bind-Value="Form.Code" />
            <ValidationMessage For="@(() => Form.Code)" />
        </FormItem>
        <FormItem Label="产品名称" Required="true">
            <InputText @bind-Value="Form.Name" />
            <ValidationMessage For="@(() => Form.Name)" />
        </FormItem>
    </FormRow>

    <FormRow>
        <FormItem Label="产品价格" Required="true">
            <InputNumber @bind-Value="Form.Price" Min="0" Precision="2" />
            <ValidationMessage For="@(() => Form.Price)" />
        </FormItem>
        <FormItem Label="库存" Required="true">
            <InputNumber @bind-Value="Form.Stock" Min="0" />
            <ValidationMessage For="@(() => Form.Stock)" />
        </FormItem>
    </FormRow>

    <FormItem Label="产品描述">
        <TextArea @bind-Value="Form.Description" Rows="3" MaxLength="500" />
        <ValidationMessage For="@(() => Form.Description)" />
    </FormItem>

    <FormItem Label="状态">
        <Checkbox @bind-Value="Form.IsActive">启用</Checkbox>
    </FormItem>
</EditForm>

@code {
    [Parameter]
    public ProductForm Form { get; set; } = new();

    [Parameter]
    public EventCallback OnValidSubmit { get; set; }

    public bool Validate()
    {
        // 额外的验证逻辑
        return true;
    }
}
```

### 5.6 创建插件

```csharp
using Known;

namespace MyApp.Plugins
{
    /// <summary>
    /// 我的插件
    /// </summary>
    public class MyPlugin : PluginBase
    {
        public override string Name => "MyPlugin";
        public override string Version => "1.0.0";
        public override string Description => "我的插件描述";

        public override void OnInitialize()
        {
            // 注册服务
            Services.AddScoped<IProductService, ProductService>();

            // 注册菜单
            AddMenu("产品管理", "/products", "fa-box", "Product:View");

            // 添加权限
            AddPermission("Product:View", "查看产品");
            AddPermission("Product:Create", "新增产品");
            AddPermission("Product:Edit", "编辑产品");
            AddPermission("Product:Delete", "删除产品");
        }

        public override void OnConfigure(IServiceCollection services, IConfiguration configuration)
        {
            // 配置插件
            services.Configure<MyPluginOptions>(
                configuration.GetSection("MyPlugin"));
        }

        public override void OnStart()
        {
            // 插件启动逻辑
        }

        public override void OnStop()
        {
            // 插件停止逻辑
        }
    }
}
```

### 5.7 配置权限

在 `appsettings.json` 中配置：

```json
{
  "MyPlugin": {
    "ConnectionString": "Server=.;Database=MyDb;Trusted_Connection=True;",
    "CacheTimeout": 600
  }
}
```

### 5.8 使用工作流

```csharp
using Known.WorkFlows;

// 创建工作流定义
var flowInfo = new FlowInfo
{
    Id = "flow001",
    Name = "请假流程",
    Steps = new List<FlowStepInfo>
    {
        new FlowStepInfo { Name = "提交", Role = "User" },
        new FlowStepInfo { Name = "部门审批", Role = "Manager" },
        new FlowStepInfo { Name = "HR审批", Role = "HR" }
    }
};

// 启动流程
var flowService = new FlowService(Context);
await flowService.StartFlowAsync(flowInfo, "申请数据");

// 处理任务
await flowService.ApproveTaskAsync("taskId", true, "同意");
await flowService.ApproveTaskAsync("taskId", false, "不同意");
```

### 5.9 使用微信功能

```csharp
using Known.Weixins;

// 配置微信
Config.App.Weixin = new WeixinConfigInfo
{
    AppId = "your_appid",
    AppSecret = "your_secret"
};

// 发送模板消息
var weixinService = new WeixinService(Context);
await weixinService.SendTemplateMessageAsync("openId", "templateId", data);
```

---

## 6. 部署指南

### 6.1 部署前准备

#### 6.1.1 环境要求

- **操作系统**: Windows Server 2019+ / Ubuntu 18.04+ / CentOS 7+
- **.NET Runtime**: .NET 8.0 Runtime
- **数据库**: MySQL 8.0+ / SQL Server 2019+ / PostgreSQL 12+ / SQLite 3+
- **Web服务器**: IIS / Nginx / Apache

#### 6.1.2 数据库初始化

```bash
# 使用 CLI 工具初始化数据库
dotnet MyApp.dll --init
```

或执行 SQL 脚本：

```sql
-- 创建数据库
CREATE DATABASE KnownDB;

-- 执行初始化脚本
-- 根据数据库类型选择对应的初始化脚本
```

### 6.2 Windows 部署 (IIS)

#### 6.2.1 安装 ASP.NET Core Hosting Bundle

下载并安装：https://dotnet.microsoft.com/download/dotnet

#### 6.2.2 发布应用

```bash
dotnet publish -c Release -o C:\inetpub\wwwroot\MyApp
```

#### 6.2.3 配置 IIS

1. 打开 IIS 管理器
2. 添加网站
3. 物理路径指向发布目录
4. 配置应用程序池为"无托管代码"

#### 6.2.4 配置 web.config

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <handlers>
      <add name="aspNetCore" path="*" verb="*" 
           modules="AspNetCoreModuleV2" 
           resourceType="Unspecified" />
    </handlers>
    <aspNetCore processPath="dotnet" 
                arguments=".\MyApp.dll" 
                stdoutLogEnabled="false" 
                stdoutLogFile=".\logs\stdout" 
                hostingModel="inprocess" />
  </system.webServer>
</configuration>
```

### 6.3 Linux 部署 (Nginx)

#### 6.3.1 安装 .NET Runtime

```bash
# Ubuntu/Debian
wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
sudo dpkg -i packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y aspnetcore-runtime-8.0

# CentOS/RHEL
sudo rpm -Uvh https://packages.microsoft.com/config/centos/8/packages-microsoft-prod.rpm
sudo yum install -y aspnetcore-runtime-8.0
```

#### 6.3.2 安装 Nginx

```bash
sudo apt-get install -y nginx
```

#### 6.3.3 发布应用

```bash
dotnet publish -c Release -o /var/www/MyApp
```

#### 6.3.4 配置 Nginx

编辑 `/etc/nginx/sites-available/myapp`：

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

#### 6.3.5 配置 Systemd 服务

创建 `/etc/systemd/system/myapp.service`：

```ini
[Unit]
Description=MyApp Application
After=network.target

[Service]
Type=notify
WorkingDirectory=/var/www/MyApp
ExecStart=/usr/bin/dotnet /var/www/MyApp/MyApp.dll
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl daemon-reload
sudo systemctl enable myapp
sudo systemctl start myapp
sudo systemctl status myapp
```

### 6.4 Docker 部署

#### 6.4.1 创建 Dockerfile

```dockerfile
# 构建阶段
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /app
COPY . .
RUN dotnet restore
RUN dotnet publish -c Release -o /app/publish

# 运行阶段
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS final
WORKDIR /app
COPY --from=build /app/publish .
EXPOSE 80
ENTRYPOINT ["dotnet", "MyApp.dll"]
```

#### 6.4.2 构建镜像

```bash
docker build -t myapp:latest .
```

#### 6.4.3 运行容器

```bash
docker run -d \
  --name myapp \
  -p 80:80 \
  -e ConnectionStrings__Default="Server=db;Database=MyDb;User Id=sa;Password=YourPassword123;" \
  myapp:latest
```

#### 6.4.4 使用 Docker Compose

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: YourPassword123
      MYSQL_DATABASE: MyDb
    volumes:
      - db_data:/var/lib/mysql
    ports:
      - "3306:3306"

  app:
    build: .
    depends_on:
      - db
    environment:
      ConnectionStrings__Default: "Server=db;Database=MyDb;User Id=root;Password=YourPassword123;"
    ports:
      - "80:80"
    volumes:
      - ./UploadFiles:/app/UploadFiles

volumes:
  db_data:
```

启动服务：

```bash
docker-compose up -d
```

### 6.5 配置 HTTPS

#### 6.5.1 使用 Let's Encrypt

```bash
# 安装 Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d yourdomain.com

# 自动续期
sudo certbot renew --dry-run
```

#### 6.5.2 使用自签名证书（开发环境）

```bash
# 生成证书
dotnet dev-certs https -ep $HOME/.aspnet/https/aspnetapp.pfx -p YourPassword123
dotnet dev-certs https --trust
```

配置 `appsettings.json`：

```json
{
  "Kestrel": {
    "Endpoints": {
      "Https": {
        "Url": "https://*:5001",
        "Certificate": {
          "Path": "/path/to/certificate.pfx",
          "Password": "YourPassword123"
        }
      }
    }
  }
}
```

### 6.6 性能优化

#### 6.6.1 启用压缩

```csharp
builder.Services.AddResponseCompression(options =>
{
    options.EnableForHttps = true;
    options.Providers.Add<BrotliCompressionProvider>();
    options.Providers.Add<GzipCompressionProvider>();
});

builder.Services.Configure<BrotliCompressionProviderOptions>(options =>
{
    options.Level = CompressionLevel.Optimal;
});
```

#### 6.6.2 配置缓存

```csharp
builder.Services.AddDistributedMemoryCache();
builder.Services.AddStackExchangeRedisCache(options =>
{
    options.Configuration = "localhost:6379";
});
```

#### 6.6.3 配置静态文件缓存

```csharp
app.UseStaticFiles(new StaticFileOptions
{
    OnPrepareResponse = ctx =>
    {
        ctx.Context.Response.Headers.Append(
            "Cache-Control", 
            "public,max-age=31536000");
    }
});
```

### 6.7 监控与日志

#### 6.7.1 配置日志

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
```

#### 6.7.2 使用 Serilog

```csharp
builder.Host.UseSerilog((context, services, configuration) => configuration
    .ReadFrom.Configuration(context.Configuration)
    .ReadFrom.Services(services)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("logs/myapp-.txt", rollingInterval: RollingInterval.Day));
```

### 6.8 备份与恢复

#### 6.8.1 数据库备份

**MySQL:**
```bash
mysqldump -u root -p MyDb > backup_$(date +%Y%m%d).sql
```

**SQL Server:**
```sql
BACKUP DATABASE MyDb TO DISK = 'C:\Backup\MyDb.bak'
```

#### 6.8.2 恢复数据库

**MySQL:**
```bash
mysql -u root -p MyDb < backup_20250101.sql
```

**SQL Server:**
```sql
RESTORE DATABASE MyDb FROM DISK = 'C:\Backup\MyDb.bak'
```

### 6.9 故障排查

#### 6.9.1 查看日志

```bash
# 查看应用日志
tail -f /var/www/MyApp/logs/myapp.txt

# 查看 Systemd 日志
journalctl -u myapp -f
```

#### 6.9.2 常见问题

| 问题 | 解决方案 |
|------|----------|
| 端口被占用 | 修改 `appsettings.json` 中的端口配置 |
| 数据库连接失败 | 检查连接字符串和数据库服务状态 |
| 文件上传失败 | 检查 `UploadPath` 目录权限和 `UploadMaxSize` 配置 |
| 内存溢出 | 增加 Kestrel 最大请求体大小或使用分片上传 |

---

## 附录

### A. 常用命令速查

```bash
# 创建新项目
dotnet new blazorserver -n MyApp

# 添加 NuGet 包
dotnet add package Known
dotnet add package Known.Core

# 还原依赖
dotnet restore

# 编译项目
dotnet build

# 运行项目
dotnet run

# 发布项目
dotnet publish -c Release -o ./publish

# 运行已发布的应用
dotnet MyApp.dll

# 查看已安装的 .NET 版本
dotnet --list-sdks
dotnet --list-runtimes
```

### B. 配置文件模板

```json
{
  "ConnectionStrings": {
    "Default": "Server=.;Database=MyDb;Trusted_Connection=True;"
  },
  "Known": {
    "IsDevelopment": true,
    "IsAdminLog": true,
    "WebLogDays": 7
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "MyPlugin": {
    "ConnectionString": "...",
    "CacheTimeout": 600
  }
}
```

### C. 参考资料

- **官方文档**: https://known.org.cn
- **Gitee**: https://gitee.com/known/Known
- **GitHub**: https://github.com/known/Known
- **Blazor 文档**: https://learn.microsoft.com/zh-cn/aspnet/core/blazor/
- **AntDesign Blazor**: https://antblazor.com/

### D. 技术支持

- **QQ群**: 865982686
- **问题反馈**: https://gitee.com/known/Known/issues
- **论坛讨论**: https://gitee.com/known/Known/boards

---

**文档版本**: 1.0.0  
**更新日期**: 2025-12-30  
**框架版本**: Known 3.4.7.1
